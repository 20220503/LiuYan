<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>现代留言板</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.21.0/dist/umd/supabase.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- Tailwind 配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6',
            secondary: '#64748b',
            accent: '#f97316',
            neutral: '#f1f5f9',
            'neutral-dark': '#1e293b',
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .message-card {
        @apply bg-white rounded-xl shadow-md p-5 mb-4 transition-all duration-300 hover:shadow-lg;
      }
      .btn {
        @apply px-4 py-2 rounded-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2;
      }
      .btn-primary {
        @apply bg-primary text-white hover:bg-primary/90 focus:ring-primary/50;
      }
      .btn-secondary {
        @apply bg-secondary text-white hover:bg-secondary/90 focus:ring-secondary/50;
      }
      .btn-accent {
        @apply bg-accent text-white hover:bg-accent/90 focus:ring-accent/50;
      }
      .input-field {
        @apply w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-200;
      }
      .reply-section {
        @apply mt-3 pl-4 border-l-2 border-gray-200 space-y-3;
      }
      .animate-fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }
      .animate-slide-up {
        animation: slideUp 0.3s ease-out;
      }
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
    }
  </style>
</head>
<body class="bg-gray-50 font-inter text-gray-800 min-h-screen flex flex-col">
  <!-- 导航栏 -->
  <header class="bg-white shadow-sm sticky top-0 z-10">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <i class="fa fa-comments text-primary text-2xl"></i>
        <h1 class="text-xl font-bold text-neutral-dark">留言板</h1>
      </div>
      <nav>
        <ul class="flex space-x-6">
          <li><a href="#" class="text-gray-600 hover:text-primary transition-colors duration-200">首页</a></li>
          <li><a href="#" class="text-gray-600 hover:text-primary transition-colors duration-200">关于</a></li>
          <li><a href="#" class="text-gray-600 hover:text-primary transition-colors duration-200">联系我们</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="flex-grow container mx-auto px-4 py-8">
    <section class="max-w-4xl mx-auto">
      <!-- 欢迎信息 -->
      <div class="mb-8 text-center">
        <h2 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-neutral-dark mb-2">分享你的想法</h2>
        <p class="text-gray-600 max-w-2xl mx-auto">在这里你可以发表留言、回复他人，参与有意义的讨论。</p>
      </div>

      <!-- 留言表单 -->
      <div class="bg-white rounded-xl shadow-md p-6 mb-8 animate-fade-in">
        <h3 class="text-xl font-semibold mb-4">发表留言</h3>
        <form id="messageForm" class="space-y-4">
          <div>
            <label for="name" class="block text-sm font-medium text-gray-700 mb-1">昵称</label>
            <input type="text" id="name" class="input-field" placeholder="请输入你的昵称" required>
          </div>
          <div>
            <label for="message" class="block text-sm font-medium text-gray-700 mb-1">留言内容</label>
            <textarea id="message" rows="4" class="input-field" placeholder="分享你的想法..." required></textarea>
          </div>
          <div class="flex justify-end">
            <button type="submit" class="btn btn-primary flex items-center">
              <i class="fa fa-paper-plane mr-2"></i> 发布留言
            </button>
          </div>
        </form>
      </div>

      <!-- 留言列表 -->
      <div id="messageList" class="space-y-6">
        <!-- 示例留言 1 -->
        <div class="message-card animate-slide-up" data-id="1">
          <div class="flex items-start mb-3">
            <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-primary mr-3">
              <i class="fa fa-user"></i>
            </div>
            <div>
              <h4 class="font-semibold text-neutral-dark">张三</h4>
              <p class="text-xs text-gray-500">2025-07-05 14:30</p>
            </div>
          </div>
          <p class="mb-4">这个留言板的界面设计很现代，使用起来也很流畅！希望能增加更多互动功能。</p>
          <div class="flex items-center space-x-4 text-sm">
            <button class="flex items-center text-gray-500 hover:text-primary transition-colors duration-200 vote-btn" data-action="up" data-id="1">
              <i class="fa fa-thumbs-up mr-1"></i> <span class="vote-count">12</span>
            </button>
            <button class="flex items-center text-gray-500 hover:text-red-500 transition-colors duration-200 vote-btn" data-action="down" data-id="1">
              <i class="fa fa-thumbs-down mr-1"></i> <span class="vote-count">3</span>
            </button>
            <button class="flex items-center text-gray-500 hover:text-primary transition-colors duration-200 reply-btn" data-id="1">
              <i class="fa fa-reply mr-1"></i> 回复
            </button>
          </div>
          
          <!-- 回复表单 -->
          <div class="reply-form hidden mt-3">
            <form class="space-y-2">
              <textarea class="input-field text-sm" rows="2" placeholder="写下你的回复..."></textarea>
              <div class="flex justify-end">
                <button type="button" class="btn btn-secondary text-sm mr-2 cancel-reply">取消</button>
                <button type="button" class="btn btn-primary text-sm submit-reply" data-id="1">回复</button>
              </div>
            </form>
          </div>
          
          <!-- 回复列表 -->
          <div class="reply-section">
            <div class="bg-gray-50 rounded-lg p-3 animate-fade-in">
              <div class="flex items-start">
                <div class="w-8 h-8 rounded-full bg-secondary/10 flex items-center justify-center text-secondary mr-2">
                  <i class="fa fa-user text-xs"></i>
                </div>
                <div>
                  <h5 class="font-medium text-sm text-neutral-dark">李四</h5>
                  <p class="text-xs text-gray-500">2025-07-05 15:10</p>
                </div>
              </div>
              <p class="text-sm mt-1">谢谢你的建议！我们正在开发更多互动功能，敬请期待。</p>
            </div>
          </div>
        </div>
        
        <!-- 示例留言 2 -->
        <div class="message-card animate-slide-up" data-id="2">
          <div class="flex items-start mb-3">
            <div class="w-10 h-10 rounded-full bg-accent/10 flex items-center justify-center text-accent mr-3">
              <i class="fa fa-user"></i>
            </div>
            <div>
              <h4 class="font-semibold text-neutral-dark">王五</h4>
              <p class="text-xs text-gray-500">2025-07-04 09:45</p>
            </div>
          </div>
          <p class="mb-4">请问这个平台支持数据导出功能吗？我想备份我的留言。</p>
          <div class="flex items-center space-x-4 text-sm">
            <button class="flex items-center text-gray-500 hover:text-primary transition-colors duration-200 vote-btn" data-action="up" data-id="2">
              <i class="fa fa-thumbs-up mr-1"></i> <span class="vote-count">5</span>
            </button>
            <button class="flex items-center text-gray-500 hover:text-red-500 transition-colors duration-200 vote-btn" data-action="down" data-id="2">
              <i class="fa fa-thumbs-down mr-1"></i> <span class="vote-count">0</span>
            </button>
            <button class="flex items-center text-gray-500 hover:text-primary transition-colors duration-200 reply-btn" data-id="2">
              <i class="fa fa-reply mr-1"></i> 回复
            </button>
          </div>
          
          <!-- 回复表单 -->
          <div class="reply-form hidden mt-3">
            <form class="space-y-2">
              <textarea class="input-field text-sm" rows="2" placeholder="写下你的回复..."></textarea>
              <div class="flex justify-end">
                <button type="button" class="btn btn-secondary text-sm mr-2 cancel-reply">取消</button>
                <button type="button" class="btn btn-primary text-sm submit-reply" data-id="2">回复</button>
              </div>
            </form>
          </div>
          
          <!-- 回复列表 -->
          <div class="reply-section">
            <!-- 暂无回复 -->
            <p class="text-sm text-gray-500 italic">暂无回复</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- 页脚 -->
  <footer class="bg-neutral-dark text-white py-6">
    <div class="container mx-auto px-4">
      <div class="flex flex-col md:flex-row justify-between items-center">
        <div class="mb-4 md:mb-0">
          <div class="flex items-center space-x-2">
            <i class="fa fa-comments text-primary"></i>
            <span class="font-semibold">现代留言板</span>
          </div>
          <p class="text-gray-400 text-sm mt-1">分享你的想法，参与讨论</p>
        </div>
        <div class="flex space-x-6">
          <a href="#" class="text-gray-400 hover:text-white transition-colors duration-200">
            <i class="fa fa-github text-xl"></i>
          </a>
          <a href="#" class="text-gray-400 hover:text-white transition-colors duration-200">
            <i class="fa fa-twitter text-xl"></i>
          </a>
          <a href="#" class="text-gray-400 hover:text-white transition-colors duration-200">
            <i class="fa fa-instagram text-xl"></i>
          </a>
        </div>
      </div>
      <div class="border-t border-gray-700 mt-6 pt-6 text-center text-gray-400 text-sm">
        &copy; 2025 现代留言板 | 保留所有权利
      </div>
    </div>
  </footer>

  <script>
    // 留言数据
    let messages = [
      {
        id: 1,
        name: '张三',
        content: '这个留言板的界面设计很现代，使用起来也很流畅！希望能增加更多互动功能。',
        timestamp: '2025-07-05 14:30',
        upvotes: 12,
        downvotes: 3,
        replies: [
          {
            name: '李四',
            content: '谢谢你的建议！我们正在开发更多互动功能，敬请期待。',
            timestamp: '2025-07-05 15:10'
          }
        ]
      },
      {
        id: 2,
        name: '王五',
        content: '请问这个平台支持数据导出功能吗？我想备份我的留言。',
        timestamp: '2025-07-04 09:45',
        upvotes: 5,
        downvotes: 0,
        replies: []
      }
    ];
    
    // DOM 元素
    const messageForm = document.getElementById('messageForm');
    const messageList = document.getElementById('messageList');
    
    // 初始化页面
    document.addEventListener('DOMContentLoaded', () => {
      renderMessages();
      setupEventListeners();
    });
    
    // 设置事件监听器
    function setupEventListeners() {
      // 提交留言表单
      messageForm.addEventListener('submit', (e) => {
        e.preventDefault();
        addNewMessage();
      });
      
      // 回复按钮点击事件委托
      messageList.addEventListener('click', (e) => {
        if (e.target.closest('.reply-btn')) {
          const replyBtn = e.target.closest('.reply-btn');
          const messageId = parseInt(replyBtn.dataset.id);
          toggleReplyForm(messageId);
        }
        
        // 取消回复按钮
        if (e.target.closest('.cancel-reply')) {
          const cancelBtn = e.target.closest('.cancel-reply');
          const messageId = parseInt(cancelBtn.closest('.reply-form').querySelector('.submit-reply').dataset.id);
          hideReplyForm(messageId);
        }
        
        // 提交回复按钮
        if (e.target.closest('.submit-reply')) {
          const submitBtn = e.target.closest('.submit-reply');
          const messageId = parseInt(submitBtn.dataset.id);
          addReply(messageId);
        }
        
        // 投票按钮
        if (e.target.closest('.vote-btn')) {
          const voteBtn = e.target.closest('.vote-btn');
          const messageId = parseInt(voteBtn.dataset.id);
          const action = voteBtn.dataset.action;
          handleVote(messageId, action, voteBtn);
        }
      });
    }
    
    // 渲染所有留言
    function renderMessages() {
      messageList.innerHTML = '';
      
      messages.forEach((message, index) => {
        const messageElement = createMessageElement(message, index);
        messageList.appendChild(messageElement);
        
        // 添加动画延迟，使留言依次出现
        setTimeout(() => {
          messageElement.classList.add('animate-slide-up');
        }, 100 * index);
      });
    }
    
    // 创建单个留言元素
    function createMessageElement(message, index) {
      const messageElement = document.createElement('div');
      messageElement.className = 'message-card';
      messageElement.dataset.id = message.id;
      
      // 生成随机颜色类
      const colors = ['primary', 'secondary', 'accent', 'green', 'purple'];
      const randomColor = colors[Math.floor(Math.random() * colors.length)];
      
      messageElement.innerHTML = `
        <div class="flex items-start mb-3">
          <div class="w-10 h-10 rounded-full bg-${randomColor}/10 flex items-center justify-center text-${randomColor} mr-3">
            <i class="fa fa-user"></i>
          </div>
          <div>
            <h4 class="font-semibold text-neutral-dark">${message.name}</h4>
            <p class="text-xs text-gray-500">${message.timestamp}</p>
          </div>
        </div>
        <p class="mb-4">${message.content}</p>
        <div class="flex items-center space-x-4 text-sm">
          <button class="flex items-center text-gray-500 hover:text-primary transition-colors duration-200 vote-btn" data-action="up" data-id="${message.id}">
            <i class="fa fa-thumbs-up mr-1"></i> <span class="vote-count">${message.upvotes}</span>
          </button>
          <button class="flex items-center text-gray-500 hover:text-red-500 transition-colors duration-200 vote-btn" data-action="down" data-id="${message.id}">
            <i class="fa fa-thumbs-down mr-1"></i> <span class="vote-count">${message.downvotes}</span>
          </button>
          <button class="flex items-center text-gray-500 hover:text-primary transition-colors duration-200 reply-btn" data-id="${message.id}">
            <i class="fa fa-reply mr-1"></i> 回复
          </button>
        </div>
        
        <!-- 回复表单 -->
        <div class="reply-form hidden mt-3">
          <form class="space-y-2">
            <textarea class="input-field text-sm" rows="2" placeholder="写下你的回复..."></textarea>
            <div class="flex justify-end">
              <button type="button" class="btn btn-secondary text-sm mr-2 cancel-reply">取消</button>
              <button type="button" class="btn btn-primary text-sm submit-reply" data-id="${message.id}">回复</button>
            </div>
          </form>
        </div>
        
        <!-- 回复列表 -->
        <div class="reply-section">
          ${message.replies.length > 0 ? 
            message.replies.map(reply => `
              <div class="bg-gray-50 rounded-lg p-3 animate-fade-in">
                <div class="flex items-start">
                  <div class="w-8 h-8 rounded-full bg-secondary/10 flex items-center justify-center text-secondary mr-2">
                    <i class="fa fa-user text-xs"></i>
                  </div>
                  <div>
                    <h5 class="font-medium text-sm text-neutral-dark">${reply.name}</h5>
                    <p class="text-xs text-gray-500">${reply.timestamp}</p>
                  </div>
                </div>
                <p class="text-sm mt-1">${reply.content}</p>
              </div>
            `).join('') : 
            '<p class="text-sm text-gray-500 italic">暂无回复</p>'
          }
        </div>
      `;
      
      return messageElement;
    }
    

    // 引入 Supabase 客户端
    import { createClient } from '@supabase/supabase-js';

    // 配置 Supabase
    const supabase = createClient(
      'https://apvxjmeumvwwpazckfyb.supabase.co', // 从 Supabase 项目设置中获取
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFwdnhqbWV1bXZ3d3BhemNrZnliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5NjkxNDMsImV4cCI6MjA2NzU0NTE0M30.0gZpnem250kYRQNNEo5MvvZoOhHAsmHJWVltJQrNU8E'      // 从 Supabase 项目设置中获取
    );
// 从数据库加载留言
async function loadMessages() {
  try {
    // 获取所有留言并按时间排序
    const { data, error } = await supabase
      .from('messages')
      .select('*, replies(*)') // 同时获取关联的回复
      .order('timestamp', { ascending: false });
    
    if (error) throw error;
    
    // 处理数据结构
    messages = data.map(msg => ({
      ...msg,
      replies: msg.replies || [] // 确保 replies 不为 undefined
    }));
    
    renderMessages();
  } catch (error) {
    console.error('Error loading messages:', error);
    alert('加载留言失败，请重试');
  }
}



// 添加新留言
async function addNewMessage() {
  const nameInput = document.getElementById('name');
  const messageInput = document.getElementById('message');
  
  const name = nameInput.value.trim();
  const content = messageInput.value.trim();
  
  if (!name || !content) return;
  
  const newMessage = {
    name,
    content,
    timestamp: new Date().toISOString(),
    upvotes: 0,
    downvotes: 0
  };
  
  try {
    // 保存到 Supabase
    const { data, error } = await supabase
      .from('messages')
      .insert([newMessage])
      .select();
    
    if (error) throw error;
    
    // 更新 UI
    messages.unshift(data[0]);
    renderMessages();
    
    // 清空表单
    nameInput.value = '';
    messageInput.value = '';
  } catch (error) {
    console.error('Error saving message:', error);
    alert('提交留言失败，请重试');
  }
}
      
      // 滚动到顶部
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    
    
    // 切换回复表单显示/隐藏
    function toggleReplyForm(messageId) {
      const replyForms = document.querySelectorAll('.reply-form');
      replyForms.forEach(form => {
        if (parseInt(form.querySelector('.submit-reply').dataset.id) !== messageId) {
          form.classList.add('hidden');
        }
      });
      
      const replyForm = document.querySelector(`.reply-form [data-id="${messageId}"]`).closest('.reply-form');
      replyForm.classList.toggle('hidden');
      
      if (!replyForm.classList.contains('hidden')) {
        replyForm.querySelector('textarea').focus();
      }
    }
    
    // 隐藏回复表单
    function hideReplyForm(messageId) {
      const replyForm = document.querySelector(`.reply-form [data-id="${messageId}"]`).closest('.reply-form');
      replyForm.classList.add('hidden');
    }
    
    // 添加回复
async function addReply(messageId) {
  const replyForm = document.querySelector(`.reply-form [data-id="${messageId}"]`).closest('.reply-form');
  const replyTextarea = replyForm.querySelector('textarea');
  const replyContent = replyTextarea.value.trim();
  
  if (!replyContent) return;
  
  try {
    // 保存回复到 Supabase
    const { data, error } = await supabase
      .from('replies')
      .insert([{
        message_id: messageId,
        name: '游客', // 在实际应用中，这里应该是当前用户的名称
        content: replyContent,
        timestamp: new Date().toISOString()
      }])
      .select();
    
    if (error) throw error;
    
    // 更新 UI
    const messageIndex = messages.findIndex(msg => msg.id === messageId);
    if (messageIndex !== -1) {
      if (!messages[messageIndex].replies) {
        messages[messageIndex].replies = [];
      }
      messages[messageIndex].replies.unshift(data[0]);
      renderMessages();
    }
    
    // 隐藏回复表单
    hideReplyForm(messageId);
  } catch (error) {
    console.error('Error saving reply:', error);
    alert('提交回复失败，请重试');
  }
}
    
   // 处理投票
async function handleVote(messageId, action, voteBtn) {
  const messageIndex = messages.findIndex(msg => msg.id === messageId);
  if (messageIndex === -1) return;
  
  const message = messages[messageIndex];
  const voteCountElement = voteBtn.querySelector('.vote-count');
  let currentCount = parseInt(voteCountElement.textContent);
  
  // 检查是否已经投过票（简化版，实际应用中应使用用户会话）
  const hasVoted = voteBtn.classList.contains('text-primary') || voteBtn.classList.contains('text-red-500');
  
  try {
    if (hasVoted) {
      // 取消投票
      currentCount--;
      voteBtn.classList.remove(action === 'up' ? 'text-primary' : 'text-red-500');
      voteBtn.classList.add('text-gray-500');
    } else {
      // 进行投票
      currentCount++;
      voteBtn.classList.remove('text-gray-500');
      voteBtn.classList.add(action === 'up' ? 'text-primary' : 'text-red-500');
      
      // 取消相反的投票
      const oppositeAction = action === 'up' ? 'down' : 'up';
      const oppositeBtn = voteBtn.parentElement.querySelector(`.vote-btn[data-action="${oppositeAction}"]`);
      const oppositeCountElement = oppositeBtn.querySelector('.vote-count');
      let oppositeCount = parseInt(oppositeCountElement.textContent);
      
      if (oppositeBtn.classList.contains(oppositeAction === 'up' ? 'text-primary' : 'text-red-500')) {
        oppositeCount--;
        oppositeBtn.classList.remove(oppositeAction === 'up' ? 'text-primary' : 'text-red-500');
        oppositeBtn.classList.add('text-gray-500');
      }
      
      oppositeCountElement.textContent = oppositeCount;
      messages[messageIndex][oppositeAction === 'up' ? 'upvotes' : 'downvotes'] = oppositeCount;
    }
    
    // 更新 UI
    voteCountElement.textContent = currentCount;
    
    // 更新数据库
    const { error } = await supabase
      .from('messages')
      .update({
        [action === 'up' ? 'upvotes' : 'downvotes']: currentCount
      })
      .eq('id', messageId);
    
    if (error) throw error;
  } catch (error) {
    console.error('Error updating vote:', error);
    alert('投票失败，请重试');
    // 回滚 UI 更改
    voteCountElement.textContent = currentCount - (hasVoted ? -1 : 1);
    voteBtn.classList.toggle('text-primary', !hasVoted && action === 'up');
    voteBtn.classList.toggle('text-red-500', !hasVoted && action === 'down');
    voteBtn.classList.toggle('text-gray-500', hasVoted);
  }
}

// 页面加载时调用
document.addEventListener('DOMContentLoaded', () => {
  loadMessages();
  setupEventListeners();
});
    
    // 格式化日期
    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      
      return `${year}-${month}-${day} ${hours}:${minutes}`;
    }

  </script>
</body>
</html>
    